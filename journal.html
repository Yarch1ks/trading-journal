<!DOCTYPE html>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // Используем единый клиент из assets/js/auth.js (window.supabaseClient)
  window.SUPABASE_URL = window.SUPABASE_URL || "https://bmxmtjbafnwoetwkuybj.supabase.co";
  window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJteG10amJhZm53b2V0d2t1eWJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MTI0NjUsImV4cCI6MjA3MDA4ODQ2NX0._V0q8Biy8wGahqdaiQSvMt3BDbKGNZzQdb8nAa2X8qo";
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const client = window.supabaseClient || (window.auth && window.auth.supabase);
      if (!client) return;
      const { data: { user } } = await client.auth.getUser();
      if (!user) window.location.href = './auth.html';
    } catch (e) {
      window.location.href = './auth.html';
    }
  });
</script>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Journal — Журнал сделок</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="app">
    <!-- Sidebar to match main layout -->
    <aside id="sidebar" class="sidebar" aria-label="Main navigation">
      <div class="sb-brand">
        <div class="logo">TJ</div>
        <div class="brand-text">
          <div class="name">TradingJournal</div>
          <div class="sub muted">Pro</div>
        </div>
        <a class="btn ghost icon" aria-label="Close menu" href="index.html">←</a>
      </div>
      <nav class="sb-nav">
        <a href="index.html" class="sb-link">
          <span class="ico">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3h8v8H3zM13 3h8v8h-8zM13 13h8v8h-8zM3 13h8v8H3z" stroke-width="2" stroke-linejoin="round"/></svg>
          </span>
          <span>Дашборд</span>
        </a>
        <a href="journal.html" class="sb-link active">
          <span class="ico">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="2" stroke-width="2"/><path d="M8 8h8M8 12h8M8 16h6" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span>Журнал</span>
        </a>
          <a href="index.html#/analytics" class="sb-link">
          <span class="ico">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18" stroke-width="2"/><path d="M7 16v2M12 10v8M17 6v12" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span>Аналитика</span>
        </a>
          <a href="index.html#/calendar" class="sb-link">
          <span class="ico">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="18" height="16" rx="2" stroke-width="2"/><path d="M16 3v4M8 3v4M3 10h18" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span>Календарь</span>
        </a>
          <a href="index.html#/goals" class="sb-link">
          <span class="ico">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 7v10M7 12h10" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span>Цели</span>
        </a>
        <a href="accounts.html" class="sb-link">
          <span class="ico">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="7" r="4" stroke-width="2"/><path d="M5.5 21a6.5 6.5 0 0 1 13 0" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span>Аккаунты</span>
        </a>
      </nav>
    </aside>

    <div class="app-shell">
      <header class="app-header app-header--pro">
        <div class="ah-left">
          <button id="sbBurger" class="icon-btn" aria-label="Open menu" title="Меню">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M3 12h18M3 18h18" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div class="branding">
            <div class="logo">TJ</div>
            <div class="title">
              <div class="brand-row">
                <span class="brand-name">TradingJournal</span>
                <span class="brand-pro">Pro</span>
              </div>
              <div class="page-row">
                <h1 id="pageTitle">Журнал сделок</h1>
                <span class="dot">•</span>
                <span class="portfolio muted">Список, фильтры, импорт/экспорт</span>
              </div>
            </div>
          </div>
        </div>
        <div class="ah-right">
          <div class="dropdown" id="periodDD">
            <button class="icon-btn dropdown-toggle" aria-haspopup="listbox" title="Период">
              <span class="dropdown-label" id="periodLbl">Всё время</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m6 9 6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <ul class="dropdown-menu" id="periodMenu" role="listbox" aria-label="Периоды">
              <li data-value="1D">День</li>
              <li data-value="1W">Неделя</li>
              <li data-value="1M">Месяц</li>
              <li data-value="3M">3 месяца</li>
              <li data-value="YTD">YTD</li>
              <li data-value="ALL" class="active">Всё время</li>
            </ul>
          </div>
          <button id="themeToggle" class="icon-btn" title="Тема" aria-label="Переключить тему">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v2m0 14v2M4.22 4.22 5.64 5.64m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78 5.64 18.36m12.72-12.72 1.42-1.42M17 12a5 5 0 1 1-10 0 5 5 0 0 1 10 0Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <div class="user">
            <img id="userAvatar" class="avatar" alt="User" src="https://api.dicebear.com/8.x/identicon/svg?seed=trader" />
            <span id="userName" class="username">Admin</span>
          </div>
        </div>
      </header>

    <main class="dashboard">
      <section class="grid kpis separated kpis-fixed">
        <div class="card kpi hoverable">
          <div class="kpi-header">
            <span class="kpi-title">Count</span>
            <span class="kpi-subtitle">(выборка)</span>
          </div>
          <div class="kpi-value" id="kCount">—</div>
        </div>
        <div class="card kpi hoverable">
          <div class="kpi-header">
            <span class="kpi-title">Win Rate</span>
            <span class="kpi-subtitle">(выборка)</span>
          </div>
          <div class="kpi-value" id="kWR">—</div>
        </div>
        <div class="card kpi hoverable">
          <div class="kpi-header">
            <span class="kpi-title">Total R</span>
            <span class="kpi-subtitle">(выборка)</span>
          </div>
          <div class="kpi-value" id="kR">—</div>
        </div>
        <div class="card kpi hoverable">
          <div class="kpi-header">
            <span class="kpi-title">P&L</span>
            <span class="kpi-subtitle">(выборка)</span>
          </div>
          <div class="kpi-value" id="kPnl">—</div>
        </div>
      </section>

      <section class="card hoverable">
        <div class="card-header split">
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="btnAdd" class="btn">+ Добавить</button>
            <button id="btnImport" class="btn ghost">Импорт CSV</button>
            <button id="btnExport" class="btn ghost">Экспорт CSV</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label class="select">
              <span>На странице</span>
              <select id="pageSize">
                <option>25</option>
                <option selected>50</option>
                <option>100</option>
              </select>
            </label>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table compact" id="tblTrades">
            <thead>
              <tr>
                <th data-sort="exitAt">Дата</th>
                <th data-sort="symbol">Инструмент</th>
                <th data-sort="strategy">Стратегия</th>
                <th data-sort="r">R</th>
                <th data-sort="pnl">P&L</th>
                <th>Заметка</th>
                <th style="width:140px;">Действия</th>
              </tr>
            </thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
        <div id="pager" style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
          <div class="muted" id="pagerInfo">—</div>
          <div style="display:flex;gap:6px;">
            <button id="prevPage" class="btn xs ghost">Предыдущая</button>
            <button id="nextPage" class="btn xs ghost">Следующая</button>
          </div>
        </div>
      </section>
    </main>

      <footer class="app-footer app-footer--pro">
        <div class="af-left">
          <div class="user-mini">
            <div class="avatar small">A</div>
            <div class="uinfo">
              <div class="uname">Admin</div>
              <div class="umail muted">admin@trading.com</div>
            </div>
          </div>
        </div>
        <div class="af-center muted">© 2025 Trading Journal Pro • Версия 2.1.0</div>
        <div class="af-right muted">
          Последнее обновление: <span id="lastUpdate">—</span>
          <span class="status-dot online"></span> Соединение
        </div>
      </footer>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,.6);z-index:80;"></div>
  <div id="modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--elev-1);border:1px solid var(--border);border-radius:12px;min-width:520px;max-width:90vw;box-shadow:var(--shadow);z-index:90;">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:12px 14px;">
      <strong id="modalTitle">Сделка</strong>
      <button id="modalClose" class="btn xs ghost">✕</button>
    </div>
    <div style="padding:12px 14px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <label class="select"><span>Start (DD-MM-YYYY)</span><input id="fStartAt" placeholder="07-08-2025"></label>
      <label class="select"><span>Start Time (HH:MM)</span><input id="fStartTime" placeholder="09:30"></label>
      <label class="select"><span>End (DD-MM-YYYY)</span><input id="fEndAt" placeholder="07-08-2025"></label>
      <label class="select"><span>End Time (HH:MM)</span><input id="fEndTime" placeholder="10:45"></label>

      <label class="select"><span>Аккаунт</span><select id="fAccount"></select></label>
      <label class="select"><span>Pair</span><input id="fPair" placeholder="ES, BTCUSDT..."></label>

      <label class="select"><span>Direction</span>
        <select id="fDirection">
          <option value="long" selected>long</option>
          <option value="short">short</option>
        </select>
      </label>
      <label class="select"><span>Session</span>
        <select id="fSession">
          <option value="ASIA" selected>ASIA</option>
          <option value="FRANKFURT">FRANKFURT</option>
          <option value="LO_KZ">LO KZ</option>
          <option value="LUNCH">LUNCH</option>
          <option value="NY_KZ">NY KZ</option>
        </select>
      </label>

      <label class="select"><span>Result</span>
        <select id="fResult">
          <option value="win">Win</option>
          <option value="be" selected>Be</option>
          <option value="loss">Loss</option>
        </select>
      </label>
      <label class="select"><span>RR (manual)</span><input id="fRR" type="number" step="0.01" placeholder="e.g. 1.5"></label>

      <label class="select"><span>Risk %</span><input id="fRiskPct" type="number" step="0.01" placeholder="e.g. 1.0"></label>
      <label class="select"><span>Risk $</span><input id="fRiskUsd" type="number" step="0.01" placeholder="e.g. 100"></label>

      <label class="select"><span>RR Auto</span><input id="fRRAuto" type="number" step="0.0001" readonly></label>
      <label class="select"><span>Profit %</span><input id="fProfitPct" type="number" step="0.0001" readonly></label>

      <label class="select"><span>Net Result $</span><input id="fNetUsd" type="number" step="0.01" readonly></label>

      <label class="select" style="grid-column:1/-1;"><span>Notes</span><input id="fNotes" placeholder=""></label>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--border);padding:12px 14px;">
      <button id="btnDelete" class="btn ghost" style="color:var(--red);border-color:var(--red);">Удалить</button>
      <button id="btnSave" class="btn">Сохранить</button>
    </div>
  </div>

  <input type="file" id="csvInput" accept=".csv" style="display:none"/>

  <!-- Ensure auth.js runs before modules to initialize window.supabaseClient -->
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/accounts.js"></script>
  <script type="module" src="assets/js/state.js"></script>
  <script type="module" src="assets/js/journal.js"></script>
  <script>
    // Debug: show client availability after all scripts loaded
    console.log("sdk", !!window.supabase, "client", !!window.supabaseClient, "auth.supabase", !!(window.auth && window.auth.supabase));
  </script>
</body>
</html>
